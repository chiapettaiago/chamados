{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-sm-10 col-md-7 col-lg-5">
    <div class="card card-elevated p-4">
      <div class="text-center mb-3">
        <div class="rounded-circle d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary" style="width:64px;height:64px;">
          <i class="bi bi-shield-lock" style="font-size:28px"></i>
        </div>
        <h3 class="mt-3 mb-0">Entrar</h3>
        <small class="text-muted">Acesse sua conta para gerenciar os chamados</small>
      </div>
      <form method="post" novalidate>
        {{ form.hidden_tag() }}
        <div class="mb-3">
          <label class="form-label">Email</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            {{ form.email(class='form-control', placeholder='seu@email.com') }}
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label">Senha</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            {{ form.password(class='form-control', placeholder='••••••••') }}
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="form-check">
            {{ form.remember(class='form-check-input', id='remember') }}
            <label for="remember" class="form-check-label">Lembrar-me</label>
          </div>
          <a href="{{ url_for('main.forgot_password') }}">Esqueci minha senha</a>
        </div>
        {{ form.submit(class='btn btn-primary w-100 mt-2') }}
        <div class="text-center mt-3">
          <small class="text-muted">Não tem conta?</small>
          <a href="{{ url_for('main.register') }}" class="ms-1">Cadastre-se</a>
        </div>
        <div class="text-center my-3"><span class="text-muted">ou</span></div>
        <button type="button" id="googleSignIn" class="btn btn-outline-dark w-100 d-flex align-items-center justify-content-center gap-2">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="20" height="20" />
          Continuar com Google
        </button>
      </form>
    </div>
  </div>
</div>

<!-- URLs e config injetadas sem quebrar o parser JS -->
<meta name="auth-firebase-url" content="{{ url_for('main.auth_firebase') }}">
<meta name="index-url" content="{{ url_for('main.index') }}">
<script id="firebase-config" type="application/json">{{ FIREBASE_CONFIG|tojson }}</script>

<script type="module">
  (async () => {
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    const { getAuth, GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');

    function getMeta(name) { return document.querySelector(`meta[name="${name}"]`)?.content; }
    const cfgEl = document.getElementById('firebase-config');
    let cfg = {};
    try { cfg = JSON.parse(cfgEl?.textContent || '{}'); } catch { cfg = {}; }
    if (!cfg || !cfg.apiKey) {
      console.warn('Firebase não configurado. Defina variáveis no .env.');
      document.getElementById('googleSignIn')?.setAttribute('disabled', 'disabled');
      return;
    }
    const firebaseConfig = {
      apiKey: cfg.apiKey,
      authDomain: cfg.authDomain,
      projectId: cfg.projectId,
      appId: cfg.appId,
      messagingSenderId: cfg.messagingSenderId,
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    document.getElementById('googleSignIn').addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const idToken = await result.user.getIdToken();
        const res = await fetch(getMeta('auth-firebase-url'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken })
        });
        const data = await res.json();
        if (res.ok && data.ok) {
          window.location.href = data.redirect || getMeta('index-url');
        } else {
          alert(data.error || 'Falha no login Google');
        }
      } catch (err) {
        console.error(err);
        alert('Falha no login Google');
      }
    });
  })();
</script>
{% endblock %}
